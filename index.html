<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ¤</text></svg>" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>è‹±è¯­AIå¯¹è¯æ•™ç»ƒ</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: '#3B82F6',
              secondary: '#64748B',
              accent: '#10B981'
            }
          }
        }
      }
    </script>
    <style>
      .gradient-bg {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }
      .chat-bubble {
        animation: slideIn 0.3s ease-out;
      }
      @keyframes slideIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
      }
      .avatar-container {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      }
      .mic-button {
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
      }
      .mic-button:hover {
        transform: scale(1.05);
        box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
      }
      .recording {
        animation: pulse 1.5s infinite;
      }
      @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.1); }
      }
      
      /* æ‰‹æœºç«¯ä¼˜åŒ– */
      @media (max-width: 768px) {
        .mobile-vh {
          height: 100vh;
          height: 100dvh; /* æ”¯æŒåŠ¨æ€è§†å£é«˜åº¦ */
        }
        
        .mobile-safe-area {
          padding-bottom: env(safe-area-inset-bottom);
        }
        
        .touch-manipulation {
          touch-action: manipulation;
        }
      }
      
      /* é˜²æ­¢ç§»åŠ¨ç«¯ç¼©æ”¾ */
      * {
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
      }
      
      input, textarea {
        -webkit-user-select: text;
        -moz-user-select: text;
        -ms-user-select: text;
        user-select: text;
      }
    </style>
  </head>
  <body>
    <div id="root"></div>
    <script type="text/babel">
      const { useState, useEffect, useRef } = React;
      
      function EnglishCoachApp() {
        const [selectedScene, setSelectedScene] = useState(null);
        const [message, setMessage] = useState('');
        const [loading, setLoading] = useState(false);
        const [isRecording, setIsRecording] = useState(false);
        const [serverStatus, setServerStatus] = useState(null);
        const [messages, setMessages] = useState([]);
        const [showSettings, setShowSettings] = useState(false);
        const [subtitle, setSubtitle] = useState('');
        
        const mediaRecorderRef = useRef(null);
        const audioChunksRef = useRef([]);
        
        // åœºæ™¯æ•°æ®
        const scenes = [
          {
            id: 'airport',
            name: 'æœºåœºå¯¹è¯',
            description: 'ç»ƒä¹ é—®è·¯ã€å€¼æœºå’Œæœºåœºå¯¼èˆªç­‰åœºæ™¯å¯¹è¯',
            icon: 'âœˆï¸',
            userRole: 'æ—…å®¢',
            aiRole: 'æœºåœºå·¥ä½œäººå‘˜',
            avatar: 'https://images.unsplash.com/photo-1551836022-4c4c79ecde51?w=400&h=400&fit=crop&crop=face&auto=format&q=80',
            avatarFallback: 'ğŸ‘©â€ğŸ’¼',
            greeting: 'Hello! Welcome to the International Airport. How may I help you today?'
          },
          {
            id: 'hotel',
            name: 'é…’åº—å…¥ä½',
            description: 'ç»ƒä¹ é…’åº—å…¥ä½ã€å’¨è¯¢è®¾æ–½å’Œè§£å†³é—®é¢˜ç­‰åœºæ™¯å¯¹è¯',
            icon: 'ğŸ¨',
            userRole: 'å®¢äºº',
            aiRole: 'å‰å°æ¥å¾…',
            avatar: 'https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=400&h=400&fit=crop&crop=face&auto=format&q=80',
            avatarFallback: 'ğŸ‘¨â€ğŸ’¼',
            greeting: 'Good evening! Welcome to Grand Hotel. How may I assist you today?'
          },
          {
            id: 'restaurant',
            name: 'é¤å…ç‚¹é¤',
            description: 'ç»ƒä¹ ç‚¹é¤ã€è¯¢é—®èœå“å’Œç‰¹æ®Šè¦æ±‚ç­‰åœºæ™¯å¯¹è¯',
            icon: 'ğŸ½ï¸',
            userRole: 'é¡¾å®¢',
            aiRole: 'æœåŠ¡å‘˜',
            avatar: 'https://images.unsplash.com/photo-1544005313-94ddf0286df2?w=400&h=400&fit=crop&crop=face&auto=format&q=80',
            avatarFallback: 'ğŸ‘©â€ğŸ³',
            greeting: 'Welcome to our restaurant! Here\'s our menu. What would you like to order today?'
          }
        ];

        // æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€
        useEffect(() => {
          const checkServerStatus = async () => {
            try {
              const res = await fetch('/api/health');
              const data = await res.json();
              setServerStatus(data);
            } catch (error) {
              setServerStatus({ status: 'error', message: 'Server not running' });
            }
          };
          
          checkServerStatus();
          const interval = setInterval(checkServerStatus, 30000);
          return () => clearInterval(interval);
        }, []);

        // åœºæ™¯åˆ‡æ¢æ—¶æ·»åŠ é—®å€™è¯­
        useEffect(() => {
          if (selectedScene) {
            const greetingMessage = {
              sender: 'ai',
              content: selectedScene.greeting,
              timestamp: Date.now()
            };
            setMessages([greetingMessage]);
          }
        }, [selectedScene]);

        // å¼€å§‹å½•éŸ³
        const startRecording = async () => {
          try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            const mediaRecorder = new MediaRecorder(stream);
            mediaRecorderRef.current = mediaRecorder;
            audioChunksRef.current = [];

            mediaRecorder.ondataavailable = (event) => {
              audioChunksRef.current.push(event.data);
            };

            mediaRecorder.start();
            setIsRecording(true);
            setSubtitle('æ­£åœ¨å½•éŸ³...');
          } catch (error) {
            alert('æ— æ³•è®¿é—®éº¦å…‹é£ï¼Œè¯·æ£€æŸ¥æƒé™è®¾ç½®');
          }
        };

        // åœæ­¢å½•éŸ³å¹¶å¤„ç†
        const stopRecording = () => {
          if (mediaRecorderRef.current && mediaRecorderRef.current.state === 'recording') {
            mediaRecorderRef.current.stop();
            setIsRecording(false);

            mediaRecorderRef.current.onstop = async () => {
              const audioBlob = new Blob(audioChunksRef.current, { type: 'audio/webm' });
              await processAudio(audioBlob);
            };
          }
        };

        // å¤„ç†éŸ³é¢‘æ–‡ä»¶
        const processAudio = async (audioBlob) => {
          setLoading(true);
          setSubtitle('å¤„ç†ä¸­...');
          
          try {
            // 1. è¯­éŸ³è½¬æ–‡å­—
            const formData = new FormData();
            formData.append('audio', audioBlob, 'audio.webm');

            const transcribeRes = await fetch('/api/transcribe', {
              method: 'POST',
              body: formData,
            });
            const transcribeData = await transcribeRes.json();
            const userText = transcribeData.text;

            setSubtitle('ä½ è¯´: ' + userText);

            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            const userMessage = { sender: 'user', content: userText, timestamp: Date.now() };
            setMessages(prev => [...prev, userMessage]);

            // 2. è·å–AIå›å¤
            const chatRes = await fetch('/api/chat', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                message: userText,
                sessionId: 'session-' + Date.now(),
                scene: selectedScene
              }),
            });
            const chatData = await chatRes.json();
            const aiResponse = chatData.response;

            // æ·»åŠ AIæ¶ˆæ¯
            const aiMessage = { sender: 'ai', content: aiResponse, timestamp: Date.now() };
            setMessages(prev => [...prev, aiMessage]);

            // 3. æ–‡å­—è½¬è¯­éŸ³
            const ttsRes = await fetch('/api/speak', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ text: aiResponse, scene: selectedScene }),
            });
            const ttsData = await ttsRes.json();
            
            if (ttsData.audio_url) {
              const audio = new Audio(ttsData.audio_url);
              audio.play();
            }

            setSubtitle('AIå›å¤: ' + aiResponse);
          } catch (error) {
            console.error('Error:', error);
            setSubtitle('å¤„ç†å¤±è´¥ï¼Œè¯·é‡è¯•');
          } finally {
            setLoading(false);
          }
        };

        // å‘é€æ–‡æœ¬æ¶ˆæ¯
        const sendTextMessage = async () => {
          if (!message.trim() || loading) return;
          
          setLoading(true);
          const userText = message;
          setMessage('');

          try {
            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            const userMessage = { sender: 'user', content: userText, timestamp: Date.now() };
            setMessages(prev => [...prev, userMessage]);

            // è·å–AIå›å¤
            const res = await fetch('/api/chat', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                message: userText,
                sessionId: 'session-' + Date.now(),
                scene: selectedScene
              }),
            });
            const data = await res.json();
            const aiResponse = data.response;

            // æ·»åŠ AIæ¶ˆæ¯
            const aiMessage = { sender: 'ai', content: aiResponse, timestamp: Date.now() };
            setMessages(prev => [...prev, aiMessage]);

            // è¯­éŸ³æ’­æ”¾
            try {
              const ttsRes = await fetch('/api/speak', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text: aiResponse, scene: selectedScene }),
              });
              const ttsData = await ttsRes.json();
              
              if (ttsData.audio_url) {
                const audio = new Audio(ttsData.audio_url);
                audio.play();
              }
            } catch (error) {
              console.error('TTS Error:', error);
            }
          } catch (error) {
            console.error('Error:', error);
          } finally {
            setLoading(false);
          }
        };

        const formatTime = (timestamp) => {
          return new Date(timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        };

        // åœºæ™¯é€‰æ‹©ç•Œé¢
        if (!selectedScene) {
          return React.createElement('div', { className: 'min-h-screen mobile-vh gradient-bg flex items-center justify-center p-4' },
            React.createElement('div', { className: 'max-w-4xl w-full' },
              React.createElement('div', { className: 'text-center mb-8 md:mb-12' },
                React.createElement('h1', { className: 'text-3xl md:text-4xl lg:text-6xl font-bold text-white mb-4' }, 
                  'ğŸ¤ è‹±è¯­AIå¯¹è¯æ•™ç»ƒ'
                ),
                React.createElement('p', { className: 'text-lg md:text-xl text-white/80 mb-6 md:mb-8' }, 
                  'é€‰æ‹©åœºæ™¯ï¼Œå¼€å§‹ä½ çš„è‹±è¯­å¯¹è¯ç»ƒä¹ '
                )
              ),
              React.createElement('div', { className: 'grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-6' },
                scenes.map(scene => 
                  React.createElement('div', {
                    key: scene.id,
                    onClick: () => setSelectedScene(scene),
                    className: 'bg-white/10 backdrop-blur-lg rounded-2xl p-6 md:p-8 cursor-pointer hover:bg-white/20 transition-all duration-300 border border-white/20 hover:scale-105 touch-manipulation'
                  },
                    React.createElement('div', { className: 'text-center' },
                      React.createElement('div', { className: 'text-4xl md:text-5xl mb-3 md:mb-4' }, scene.icon),
                      React.createElement('h3', { className: 'text-xl md:text-2xl font-bold text-white mb-2 md:mb-3' }, scene.name),
                      React.createElement('p', { className: 'text-sm md:text-base text-white/70 mb-3 md:mb-4' }, scene.description),
                      React.createElement('div', { className: 'text-xs md:text-sm text-white/60' },
                        `ä½ çš„è§’è‰²ï¼š${scene.userRole} | AIè§’è‰²ï¼š${scene.aiRole}`
                      )
                    )
                  )
                )
              )
            )
          );
        }

        // ä¸»ç•Œé¢ - å“åº”å¼å¸ƒå±€
        return React.createElement('div', { className: 'h-screen mobile-vh flex flex-col bg-gray-50' },
          // é¡¶éƒ¨å¯¼èˆª - ç§»åŠ¨ç«¯ä¼˜åŒ–
          React.createElement('header', { className: 'bg-white border-b border-gray-200 px-4 md:px-6 py-3 md:py-4 flex items-center justify-between flex-shrink-0' },
            React.createElement('div', { className: 'flex items-center space-x-2 md:space-x-4 flex-1 min-w-0' },
              React.createElement('button', {
                onClick: () => setSelectedScene(null),
                className: 'text-gray-500 hover:text-gray-700 p-2 rounded-lg hover:bg-gray-100 touch-manipulation flex-shrink-0'
              }, 'â† è¿”å›'),
              React.createElement('div', { className: 'flex items-center space-x-2 md:space-x-3 min-w-0' },
                React.createElement('span', { className: 'text-xl md:text-2xl flex-shrink-0' }, selectedScene.icon),
                React.createElement('div', { className: 'min-w-0' },
                  React.createElement('h1', { className: 'text-lg md:text-xl font-semibold text-gray-800 truncate' }, selectedScene.name),
                  React.createElement('p', { className: 'text-xs md:text-sm text-gray-500 truncate' }, 
                    `ä½ æ˜¯${selectedScene.userRole}ï¼ŒAIæ˜¯${selectedScene.aiRole}`
                  )
                )
              )
            ),
            React.createElement('div', { className: 'flex items-center space-x-2 md:space-x-4 flex-shrink-0' },
              React.createElement('div', { 
                className: `px-2 md:px-3 py-1 rounded-full text-xs md:text-sm ${
                  serverStatus?.status === 'ok' 
                    ? 'bg-green-100 text-green-800' 
                    : 'bg-red-100 text-red-800'
                }`
              }, 
                serverStatus?.status === 'ok' 
                  ? `âœ… ${serverStatus.mode?.toUpperCase()}` 
                  : 'âŒ ç¦»çº¿'
              )
            )
          ),

          // ä¸»è¦å†…å®¹åŒºåŸŸ - å“åº”å¼å¸ƒå±€
          React.createElement('div', { className: 'flex-1 flex flex-col md:flex-row overflow-hidden' },
            // è™šæ‹Ÿå½¢è±¡åŒºåŸŸ - ç§»åŠ¨ç«¯é¡¶éƒ¨ï¼Œæ¡Œé¢ç«¯å·¦ä¾§
            React.createElement('div', { className: 'md:w-1/3 bg-gradient-to-br from-blue-100 to-purple-100 flex flex-col items-center justify-center p-4 md:p-8 relative flex-shrink-0' },
              React.createElement('div', { className: 'text-center' },
                React.createElement('div', { className: 'w-20 h-20 md:w-32 md:h-32 rounded-full mb-3 md:mb-6 avatar-container flex items-center justify-center mx-auto overflow-hidden' },
                  React.createElement('img', {
                    src: selectedScene.avatar,
                    alt: selectedScene.aiRole,
                    className: 'w-full h-full object-cover',
                    onError: (e) => {
                      e.target.style.display = 'none';
                      e.target.nextSibling.style.display = 'flex';
                    },
                    onLoad: (e) => {
                      e.target.style.display = 'block';
                      e.target.nextSibling.style.display = 'none';
                    }
                  }),
                  React.createElement('div', {
                    className: 'w-full h-full flex items-center justify-center text-2xl md:text-4xl',
                    style: { display: 'none' }
                  }, selectedScene.avatarFallback)
                ),
                React.createElement('h3', { className: 'text-lg md:text-xl font-semibold text-gray-800 mb-1 md:mb-2' }, selectedScene.aiRole),
                React.createElement('p', { className: 'text-sm md:text-base text-gray-600' }, 'American Accent')
              ),
              
              // å­—å¹•åŒºåŸŸ - ç§»åŠ¨ç«¯ä¼˜åŒ–
              subtitle && React.createElement('div', { 
                className: 'absolute bottom-2 md:bottom-8 left-2 md:left-4 right-2 md:right-4 bg-white/90 backdrop-blur-sm rounded-xl p-3 md:p-4 text-sm text-gray-700 shadow-lg border border-white/20' 
              },
                React.createElement('div', { className: 'flex items-start space-x-2' },
                  React.createElement('div', { className: 'text-blue-500 font-medium flex-shrink-0' }, 'ğŸ’¬'),
                  React.createElement('div', { className: 'flex-1 break-words' }, subtitle)
                )
              )
            ),

            // å¯¹è¯åŒºåŸŸ - ç§»åŠ¨ç«¯ä¼˜åŒ–
            React.createElement('div', { className: 'flex-1 flex flex-col min-h-0' },
              // æ¶ˆæ¯æ˜¾ç¤ºåŒºåŸŸ
              React.createElement('div', { className: 'flex-1 overflow-y-auto p-4 md:p-6 space-y-3 md:space-y-4' },
                messages.map((msg, index) =>
                  React.createElement('div', {
                    key: index,
                    className: `flex ${msg.sender === 'user' ? 'justify-end' : 'justify-start'} chat-bubble`
                  },
                    React.createElement('div', {
                      className: `max-w-[85%] md:max-w-[80%] rounded-2xl px-3 md:px-4 py-2 md:py-3 ${
                        msg.sender === 'user' 
                          ? 'bg-primary text-white' 
                          : 'bg-white border border-gray-200 text-gray-800'
                      }`
                    },
                      React.createElement('p', { className: 'mb-1 text-sm md:text-base break-words' }, msg.content),
                      React.createElement('div', { 
                        className: `text-xs ${msg.sender === 'user' ? 'text-blue-200' : 'text-gray-500'}` 
                      }, formatTime(msg.timestamp))
                    )
                  )
                )
              ),

              // åº•éƒ¨è¾“å…¥åŒºåŸŸ - ç§»åŠ¨ç«¯ä¼˜åŒ–
              React.createElement('div', { className: 'border-t border-gray-200 bg-white p-4 md:p-6 mobile-safe-area flex-shrink-0' },
                React.createElement('div', { className: 'flex items-center space-x-3 md:space-x-4' },
                  // è¯­éŸ³æŒ‰é’®
                  React.createElement('button', {
                    onClick: isRecording ? stopRecording : startRecording,
                    disabled: loading,
                    className: `w-12 h-12 md:w-14 md:h-14 rounded-full flex items-center justify-center text-white text-lg md:text-xl mic-button touch-manipulation flex-shrink-0 ${
                      isRecording 
                        ? 'bg-red-500 recording' 
                        : loading 
                          ? 'bg-gray-400 cursor-not-allowed'
                          : 'bg-primary hover:bg-blue-600'
                    }`
                  }, 
                    isRecording ? 'â¹ï¸' : loading ? 'â³' : 'ğŸ¤'
                  ),
                  
                  // æ–‡æœ¬è¾“å…¥
                  React.createElement('div', { className: 'flex-1 flex space-x-2' },
                    React.createElement('input', {
                      type: 'text',
                      value: message,
                      onChange: (e) => setMessage(e.target.value),
                      onKeyPress: (e) => e.key === 'Enter' && sendTextMessage(),
                      placeholder: 'è¾“å…¥è‹±è¯­æ¶ˆæ¯...',
                      className: 'flex-1 px-3 md:px-4 py-2 md:py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-primary focus:border-transparent text-sm md:text-base'
                    }),
                    React.createElement('button', {
                      onClick: sendTextMessage,
                      disabled: loading || !message.trim(),
                      className: 'px-4 md:px-6 py-2 md:py-3 bg-accent hover:bg-green-600 disabled:bg-gray-400 text-white rounded-xl font-medium text-sm md:text-base touch-manipulation flex-shrink-0'
                    }, 'å‘é€')
                  )
                ),
                
                React.createElement('div', { className: 'text-center mt-2 md:mt-3' },
                  React.createElement('p', { className: 'text-xs md:text-sm text-gray-500' },
                    isRecording ? 'æ­£åœ¨å½•éŸ³ï¼Œç‚¹å‡»åœæ­¢' : 'ç‚¹å‡»éº¦å…‹é£å½•éŸ³æˆ–è¾“å…¥æ–‡å­—å¯¹è¯'
                  )
                )
              )
            )
          )
        );
      }
      
      ReactDOM.render(React.createElement(EnglishCoachApp), document.getElementById('root'));
    </script>
  </body>
</html>